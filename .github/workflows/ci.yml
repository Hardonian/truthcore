name: Truth Core CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 1'  # Weekly security scans on Monday

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  # ============================================================================
  # Main Test Suite
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev,parquet]'

      - name: Run linter (ruff)
        run: |
          ruff check src/truthcore tests --output-format=github

      - name: Run type checker (pyright)
        run: |
          pyright src/truthcore --outputjson || true

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short --cov=truthcore --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ============================================================================
  # Security: Dependency Scanning
  # ============================================================================
  security-audit:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev,parquet]'

      - name: Run pip-audit (Python dependencies)
        run: |
          pip install pip-audit
          pip-audit --desc --format=json || true

      - name: Check for secrets (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --redact -v
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ============================================================================
  # Security: CodeQL Analysis
  # ============================================================================
  codeql:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      security-events: write

    strategy:
      matrix:
        language: [python, javascript]

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================================================
  # TypeScript SDK Tests
  # ============================================================================
  typescript-sdk:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: |
          pnpm install
          cd packages/ts-contract-sdk && pnpm install

      - name: Run TypeScript lint
        run: |
          cd packages/ts-contract-sdk && pnpm run lint

      - name: Run TypeScript type check
        run: |
          cd packages/ts-contract-sdk && pnpm run typecheck

      - name: Run TypeScript tests
        run: |
          cd packages/ts-contract-sdk && pnpm run test

      - name: Build TypeScript SDK
        run: |
          cd packages/ts-contract-sdk && pnpm run build

      - name: Run npm audit
        run: |
          cd packages/ts-contract-sdk && npm audit --audit-level=high || true

  # ============================================================================
  # Contract Kit Validation & Doctor
  # ============================================================================
  contract-kit:
    runs-on: ubuntu-latest
    needs: [test, typescript-sdk]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
          pnpm install

      - name: Run contracts:check
        run: |
          pnpm run contracts:check

      - name: Run doctor
        run: |
          pnpm run doctor

  # ============================================================================
  # Dashboard Build
  # ============================================================================
  dashboard:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd dashboard && npm install

      - name: Build dashboard
        run: |
          cd dashboard && npm run build

  # ============================================================================
  # Replay & Simulation Tests
  # ============================================================================
  replay-simulation-tests:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev,parquet]'

      - name: Create example bundle
        run: |
          python scripts/create_example_bundle.py

      - name: Test bundle export
        run: |
          mkdir -p /tmp/test-results
          truthctl bundle export \
            --run-dir examples/replay_bundle/run_output \
            --inputs examples/replay_bundle/inputs \
            --out /tmp/test-bundle \
            --profile ui \
            --mode pr
          test -f /tmp/test-bundle/run_manifest.json
          echo "Bundle export: SUCCESS"

      - name: Test replay command
        run: |
          truthctl replay \
            --bundle examples/replay_bundle/bundle \
            --out /tmp/replay-results
          test -f /tmp/replay-results/replay_report.json
          test -f /tmp/replay-results/replay_report.md
          test -f /tmp/replay-results/verdict.json
          echo "Replay: SUCCESS"

      - name: Test replay with strict mode
        run: |
          truthctl replay \
            --bundle examples/replay_bundle/bundle \
            --out /tmp/replay-strict \
            --strict || true
          echo "Replay strict mode: SUCCESS (or expected failure)"

      - name: Test simulation command
        run: |
          truthctl simulate \
            --bundle examples/replay_bundle/bundle \
            --out /tmp/sim-results \
            --changes examples/replay_bundle/changes_example.yaml
          test -f /tmp/sim-results/simulation_report.json
          test -f /tmp/sim-results/simulation_report.md
          test -f /tmp/sim-results/verdict.json
          echo "Simulation: SUCCESS"

      - name: Test simulation with mode override
        run: |
          truthctl simulate \
            --bundle examples/replay_bundle/bundle \
            --out /tmp/sim-main \
            --changes examples/replay_bundle/changes_example.yaml \
            --mode main
          echo "Simulation with mode override: SUCCESS"

  # ============================================================================
  # Compatibility Tests
  # ============================================================================
  compat-mode-tests:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev,parquet]'

      - name: Test judge with compat mode
        run: |
          mkdir -p /tmp/compat-test
          # Create minimal test inputs
          echo '{"passed": true, "findings": []}' > /tmp/compat-test/readiness.json
          # Run judge with --compat flag
          truthctl judge \
            --inputs /tmp/compat-test \
            --profile base \
            --out /tmp/compat-output \
            --compat || true
          echo "Judge compat mode: SUCCESS (or expected with minimal inputs)"

      - name: Test verdict with compat mode
        run: |
          # Use the example bundle outputs for verdict testing
          truthctl verdict \
            --inputs examples/replay_bundle/outputs \
            --profile ui \
            --mode pr \
            --out /tmp/verdict-compat \
            --compat
          test -f /tmp/verdict-compat/verdict.json
          echo "Verdict compat mode: SUCCESS"

      - name: Test policy with compat mode
        run: |
          # Run policy scan with --compat
          truthctl policy run \
            --inputs examples/replay_bundle/inputs \
            --pack base \
            --out /tmp/policy-compat \
            --compat || true
          echo "Policy compat mode: SUCCESS (or expected with minimal inputs)"

  # ============================================================================
  # Integration Tests
  # ============================================================================
  integration-tests:
    runs-on: ubuntu-latest
    needs: [test, replay-simulation-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev,parquet]'

      - name: Full workflow test
        run: |
          echo "=== Step 1: Run judge ==="
          mkdir -p /tmp/full-test/inputs
          # Create test inputs
          echo '{"elements": [{"id": "btn1", "clickable": true}]}' > /tmp/full-test/inputs/ui_facts.json
          
          truthctl judge \
            --inputs /tmp/full-test/inputs \
            --profile ui \
            --out /tmp/full-test/run1 \
            --manifest
          
          echo "=== Step 2: Export bundle ==="
          truthctl bundle export \
            --run-dir /tmp/full-test/run1 \
            --inputs /tmp/full-test/inputs \
            --out /tmp/full-test/bundle
          
          echo "=== Step 3: Replay bundle ==="
          truthctl replay \
            --bundle /tmp/full-test/bundle \
            --out /tmp/full-test/replay
          
          echo "=== Step 4: Create simulation changes ==="
          cat > /tmp/full-test/changes.yaml << 'EOF'
          thresholds:
            max_highs: 10
            max_total_points: 200
          disabled_engines: []
          suppressions: []
          EOF
          
          echo "=== Step 5: Run simulation ==="
          truthctl simulate \
            --bundle /tmp/full-test/bundle \
            --out /tmp/full-test/sim \
            --changes /tmp/full-test/changes.yaml
          
          echo "=== Full workflow: SUCCESS ==="

  # ============================================================================
  # Determinism Test
  # ============================================================================
  determinism-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev,parquet]'

      - name: Test deterministic replay
        run: |
          # Create example bundle
          python scripts/create_example_bundle.py
          
          # Replay multiple times and compare
          for i in 1 2 3; do
            truthctl replay \
              --bundle examples/replay_bundle/bundle \
              --out /tmp/determinism-$i
          done
          
          # Check that all replays produced same verdict
          diff /tmp/determinism-1/verdict.json /tmp/determinism-2/verdict.json
          diff /tmp/determinism-2/verdict.json /tmp/determinism-3/verdict.json
          
          echo "Determinism test: SUCCESS"

  # ============================================================================
  # Build and Publish (on main branch only)
  # ============================================================================
  build-and-publish:
    runs-on: ubuntu-latest
    needs: [test, replay-simulation-tests, compat-mode-tests, security-audit, codeql, contract-kit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # ============================================================================
  # Conventional Commits Check
  # ============================================================================
  conventional-commits:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check conventional commits
        uses: webiny/action-conventional-commits@v1.3.0

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "evidence-packets/golden_test_packet.schema.json",
  "title": "Golden Test Evidence Packet",
  "description": "Schema for golden test packets that bind input facts to expected policy evaluator outcomes, preventing ruleset regressions.",
  "type": "object",
  "required": [
    "packet_id",
    "schema_version",
    "rule_id",
    "rule_version",
    "pack_name",
    "input_facts",
    "expected"
  ],
  "additionalProperties": false,
  "properties": {
    "packet_id": {
      "type": "string",
      "pattern": "^GP-[0-9]{4}$",
      "description": "Unique golden packet identifier (GP-0001 .. GP-9999)"
    },
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Version of this golden test packet schema"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of what this test case validates"
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Tags for filtering (e.g. edge-case, regression, boundary)"
    },
    "rule_id": {
      "type": "string",
      "minLength": 1,
      "description": "Policy rule ID being tested"
    },
    "rule_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the policy pack containing the rule"
    },
    "pack_name": {
      "type": "string",
      "enum": ["base", "security", "privacy", "logging", "agent"],
      "description": "Name of the policy pack"
    },
    "input_facts": {
      "type": "object",
      "required": ["files"],
      "additionalProperties": false,
      "properties": {
        "files": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["path", "content"],
            "additionalProperties": false,
            "properties": {
              "path": {
                "type": "string",
                "description": "Relative file path within the scan directory"
              },
              "content": {
                "type": "string",
                "description": "File content to scan"
              }
            }
          },
          "description": "Files to create in the scan input directory"
        }
      },
      "description": "Input facts that define the test scenario"
    },
    "expected": {
      "type": "object",
      "required": ["triggered", "finding_count_min"],
      "additionalProperties": false,
      "properties": {
        "triggered": {
          "type": "boolean",
          "description": "Whether the rule is expected to produce findings"
        },
        "finding_count_min": {
          "type": "integer",
          "minimum": 0,
          "description": "Minimum number of findings expected"
        },
        "finding_count_max": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of findings expected (optional upper bound)"
        },
        "has_blocking": {
          "type": "boolean",
          "description": "Whether any finding should be blocking (BLOCKER severity)"
        },
        "severity": {
          "type": "string",
          "enum": ["BLOCKER", "HIGH", "MEDIUM", "LOW", "INFO"],
          "description": "Expected severity of findings"
        },
        "finding_rule_ids": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Expected rule IDs in findings (for rules without explicit matchers that use built-in patterns)"
        }
      },
      "description": "Expected evaluation outcome"
    },
    "explanation_trace": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "why_triggered": {
          "type": "string",
          "description": "Explanation of why the rule should (or should not) trigger"
        },
        "matched_pattern": {
          "type": "string",
          "description": "The specific pattern or content expected to match"
        },
        "scanner_type": {
          "type": "string",
          "enum": ["SecretScanner", "PIIScanner", "ConfigScanner", "ArtifactScanner"],
          "description": "Which scanner is expected to process this rule"
        },
        "edge_case_notes": {
          "type": "string",
          "description": "Notes about edge cases or boundary conditions"
        }
      },
      "description": "Explanation trace for debugging and documentation"
    }
  }
}
